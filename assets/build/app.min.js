/**
 * @name Aroskanalen
 * @version v3.5.0
 * @link https://github.com/aroskanalen/screen
 */
angular.module("ikApp",["ngAnimate","angular.css.injector","itkLog","itkRegion","itkDateComponent","itkDigitalClockComponent","itkKeypress"]).config(["$sceDelegateProvider",function(e){"use strict";e.resourceUrlWhitelist(["self","**"])}]).config(["$provide",function(e){"use strict";e.decorator("$exceptionHandler",["$delegate","$injector",function(e,n){return function(t,o){e(t,o),n.get("itkLog").error(t,o)}}])}]),function(){function e(){n=null,document.body.style.cursor="url(/assets/images/trans.gif),none",t=!1}var n=null,t=!1,o=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;o||document.addEventListener("mousemove",function(){n&&window.clearTimeout(n),t||(document.body.style.cursor="default",t=!0),n=window.setTimeout(e,5e3)})}(),angular.module("ikApp").controller("IndexController",["$scope","$rootScope","$timeout","socket","itkLog","cssInjector",function(e,n,t,o,i,s){"use strict";window.hasOwnProperty("slideFunctions")||(window.slideFunctions=[]),e.template="app/pages/index/init.html?"+window.config.version;var r=!1;e.fallbackImageUrl=window.config.fallback_image?window.config.fallback_image:"assets/images/fallback_default.png",e.displayFallbackImage=!0;var a=[],c=[];n.$on("regionInfo",function(n,t){c[t.id]=t;var o=!1;c.forEach(function(e){e.scheduledSlides>0&&(o=!0)}),e.displayFallbackImage=!o}),n.$on("activationNotComplete",function(){e.$apply(function(){e.template="app/pages/notActivated/not-activated.html?"+window.config.version})}),n.$on("awaitingContent",function(){e.$apply(function(){e.template="app/pages/index/awaiting-content.html?"+window.config.version})}),n.$on("start",function(o,c){r||(e.$apply(function(){s.add(c.template.path_css),e.template=c.template.path_live,e.templateDirectory=c.template.path,e.options=c.options}),t(function(){r=!0;for(var e=0;e<a.length;e++)i.info("Emitting channel saved channel."),n.$emit("addChannel",a[e])},5e3))}),n.$on("addChannel",function(e,n){r||(i.info("Saving channel till screen is ready."),a.push(n))}),e.logout=function(){o.logout()},o.start()}]),angular.module("ikApp").controller("NotActivatedController",["$scope","socket",function(e,n){"use strict";e.activationCode="",e.submitActivationCode=function(){n.activateScreenAndConnect(e.activationCode)}}]),angular.module("ikApp").filter("activeEvents",function(){"use strict";return function(e){if(!angular.isArray(e))return!1;for(var n=parseInt(Date.now()/1e3),t=[],o=0;o<e.length;o++){var i=e[o];i.from&&i.to&&i.to>=n?t.push(i):i.from&&i.from>=n&&t.push(i)}return t}}),function(){"use strict";function e(e,n){this.scope=e,this.itkLog=n,this.scope.progressBoxElements=0,this.scope.progressBoxElementsIndex=0}function n(e,n,t,o,i,s,r,a,c){this.scope=e,this.itkLog=n,this.progressBar=t,this.$timeout=o,this.$rootScope=i,this.$http=s,this.$interval=r,this.$sce=a,this.$filter=c,this.fadeTime=1e3,this.timeout=null}var t=angular.module("itkRegion",[]);e.prototype.start=function(e){this.scope.progressBarStyle={overflow:"hidden","-webkit-transition":"width "+e+"s linear","-moz-transition":"width "+e+"s linear","-o-transition":"width "+e+"s linear",transition:"width "+e+"s linear",width:"100%"}},e.prototype.resetBox=function(){var e=this;e.scope.progressBoxElements=0,e.scope.progressBoxElementsIndex=0;for(var n=0,t=0;t<e.scope.channelKeys[e.scope.displayIndex].length;t++){var o=e.scope.channelKeys[e.scope.displayIndex][t],i=e.scope.channels[e.scope.displayIndex][o];if(i.isScheduled)for(var s=0;s<i.slides.length;s++){var r=i.slides[s];r.isScheduled&&n++}}return e.scope.progressBoxElements=n,n},e.prototype.next=function(){this.reset(),this.scope.progressBoxElementsIndex++},e.prototype.reset=function(){this.scope.progressBarStyle={width:"0"}},n.prototype.broadcastInfo=function(e){var n=this;n.$rootScope.$broadcast("regionInfo",{id:n.scope.regionId,scheduledSlides:e})},n.prototype.updateSlideScheduleState=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.schedule_from,o=e.schedule_to,i=t&&0!==t,s=o&&0!==o;i&&!s?e.isScheduled=t<n:i&&s?e.isScheduled=t<o&&t<n&&o>n:!i&&s?e.isScheduled=o>n:e.isScheduled=!0},n.prototype.isChannelScheduled=function(e){if(!e.schedule_repeat)return!0;var n=new Date,t=n.getDay(),o=n.getHours(),i=e.schedule_repeat_from,s=e.schedule_repeat_to,r=e.schedule_repeat_days;if(!i&&!s&&0===r.length)return!0;for(var a=!1,c=0;c<r.length;c++)if(r[c].id===t){a=!0;break}return!!a&&(!(i>s)&&(o>=i&&o<s))},n.prototype.updateChannelScheduleState=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.publish_from,o=e.publish_to;e.isScheduled=!1,this.isChannelScheduled(e)&&(t||o?t&&n>t&&(!o||n<o)?e.isScheduled=!0:e.isScheduled=!t&&n<o:e.isScheduled=!0)},n.prototype.updateScheduling=function(){var e=this,n=e.scope.displayIndex;e.scope.channelKeys[n].forEach(function(t,o,i){var s=e.scope.channels[n][t];e.updateChannelScheduleState(s),s.slides.forEach(function(n){e.updateSlideScheduleState(n)})})},n.prototype.isContentScheduled=function(){for(var e,n=this,t=n.scope.displayIndex,o=n.scope.channelKeys[n.scope.displayIndex].length,i=0;i<o;i++){var s=n.scope.channels[t][n.scope.channelKeys[t][i]];if(s.isScheduled)for(var r=0;r<s.slides.length;r++)if(e=s.slides[r],e.isScheduled)return!0}return!1},n.prototype.restartShow=function(){var e=this;if(e.scope.slideIndex=-1,e.scope.channelKey=-1,e.scope.slidesUpdated){var n=e.getShadowIndex(),t=e.scope.displayIndex,o=e.scope.channels;o[t]=angular.copy(o[n]),e.scope.channelKeys[t]=Object.keys(o[t]),e.scope.displayIndex=n,e.scope.slidesUpdated=!1}return e.updateScheduling(),e.broadcastInfo(e.progressBar.resetBox()),e.isContentScheduled()?void e.nextChannel():(e.$timeout.cancel(e.timeout),void(e.timeout=e.$timeout(function(){e.restartShow()},5e3)))},n.prototype.nextChannel=function o(){var e=this;e.scope.channelKey++;var n=e.scope.displayIndex,t=e.scope.channelKeys;if(e.scope.channelKey<t[n].length){var i=t[n][e.scope.channelKey],o=e.scope.channels[n][i];o.isScheduled?(e.scope.channelIndex=i,e.scope.slideIndex=-1,e.nextSlide()):e.nextChannel()}else e.restartShow()},n.prototype.nextSlide=function(){var e=this,n=e.scope.slideIndex+1,t=e.scope.displayIndex,o=e.scope.channels,i=e.scope.channelIndex;if(!o[t][i]||n>=o[t][i].slides.length)return void e.nextChannel();if(void 0===o[t][i]||o[t][i].slides.length<=0)return void e.nextChannel();e.scope.slideIndex=n;var s=o[t][i].slides[n];s.isScheduled?e.displaySlide():e.isContentScheduled()?(e.itkLog.info("Slide schedule: slides remain."),e.nextSlide()):(e.itkLog.info("Slide schedule: slides do not remain"),e.$timeout.cancel(e.timeout),e.$timeout(function(){e.restartShow()},1e3))},n.prototype.updateSlideShow=function(e){var n=this,t=n.getShadowIndex(),o=""+e.id;n.scope.channels[t][o]=angular.copy(e),n.scope.channelKeys[t]=Object.keys(n.scope.channels[t]),n.scope.slidesUpdated=!0},n.prototype.displaySlide=function(){var e=this;e.$timeout.cancel(e.timeout),e.progressBar.next();var n=e.scope.channels[e.scope.displayIndex][e.scope.channelIndex].slides[e.scope.slideIndex];window.slideFunctions[n.js_script_id].run(n,e)},n.prototype.getShadowIndex=function(){return(this.scope.displayIndex+1)%2},t.directive("region",["$rootScope","$timeout","$interval","itkLog","$http","$sce","$filter",function(t,o,i,s,r,a,c){return{restrict:"E",scope:{regionId:"=",showProgress:"=",scale:"="},link:function(d){d.channels=[{},{}],d.channelKeys=[[],[]];var l=!1;d.slideIndex=null,d.channelIndex=null,d.displayIndex=0,d.slidesUpdated=!1;var u=new e(d,s),p=new n(d,s,u,o,t,r,i,a,c);p.broadcastInfo(0),t.$on("addChannel",function(e,n){if(null!==n){if(n.regions.indexOf(d.regionId)===-1){var t=p.getShadowIndex(),i=""+n.data.id;return void(d.channels[t].hasOwnProperty(i)&&(s.info("Removing channel "+n.data.id+" from region "+d.regionId),delete d.channels[t][i],d.channelKeys[t]=Object.keys(d.channels[t]),d.slidesUpdated=!0))}s.info("Adding channel "+n.data.id+" to region "+d.regionId),l?p.updateSlideShow(n.data):(l=!0,d.$apply(function(){var e=""+n.data.id;d.channels[0][e]=angular.copy(n.data),d.channels[1][e]=angular.copy(n.data),d.channelKeys[0]=Object.keys(d.channels[0]),d.channelKeys[1]=Object.keys(d.channels[1]),d.channelKey=-1,o(function(){d.slideIndex=-1,p.updateScheduling(),p.broadcastInfo(u.resetBox()),p.nextChannel()},1e3)}))}}),t.$on("removeChannel",function(e,n){var t=p.getShadowIndex(),o=""+n.id;d.channels[t].hasOwnProperty(o)&&(delete d.channels[t][o],d.channelKeys[t]=Object.keys(d.channels[t]),d.slidesUpdated=!0)})},templateUrl:"app/shared/region/region.html?"+window.config.version}}])}.call(this),angular.module("ikApp").factory("socket",["$rootScope","itkLog",function(e,n){"use strict";var t,o,i={},s=window.config,r=!1,a=function(){var e=function(e){var n=this;n.get=function(){var n=new RegExp("(?:^"+e+"|s*"+e+")=(.*?)(?:;|$)","g"),t=n.exec(document.cookie);return null===t?void 0:t[1]},n.set=function(n,t){var o=e+"="+escape(n)+";";void 0===t&&(t="Thu, 01 Jan 2018 00:00:00 GMT"),o+="expires="+t+";",o+="path=/;",o+="domain="+document.domain+";",s.cookie.secure===!0&&(o+=" secure"),document.cookie=o},n.remove=function(){n.set("","Thu, 01 Jan 1970 00:00:00 GMT")}};return e}(),c=function(){o=new a("indholdskanalen_token");var n=o.get();void 0===n?e.$emit("activationNotComplete"):l(n)},d=function u(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",s.resource.server+s.resource.uri+"/socket.io/socket.io.js?"+s.version),t.onload=function(){"undefined"==typeof io?(n.error("Socket.io not loaded"),document.getElementsByTagName("head")[0].removeChild(t),window.setTimeout(u(e),100)):e()},document.getElementsByTagName("head")[0].appendChild(t)},l=function(i){var c=new a("indholdskanalen_uuid"),d=c.get();if(void 0===d){var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";d=l.charAt(Math.floor(Math.random()*l.length))+Math.random().toString(36).substring(2),c.set(d)}t=io.connect(s.ws.server,{query:"token="+i+"&uuid="+d,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0}),t.on("connect",function(){o.set(i),n.log("Connection to middleware"),r||(r=!0),t.emit("ready")}),t.on("booted",function(e){o.remove(),location.reload(!0)}),t.on("channelRemoved",function(n){e.$emit("removeChannel",n)}),t.on("error",function(e){n.error(e)}),t.on("disconnect",function(){n.info("disconnect")}),t.on("reconnect",function(){n.info("reconnect")}),t.on("reconnect_attempt",function(){n.info("reconnect_attempt")}),t.on("connect_error",function(){n.error("connect_error")}),t.on("reconnect_error",function(){n.error("reconnect_error")}),t.on("reconnect_failed",function(){n.error("reconnect_failed")}),t.on("ready",function(t){e.$emit("start",t.screen),200!==t.statusCode?404!==t.statusCode&&n.error("Code: "+t.statusCode+" - Connection error"):r||e.$emit("awaitingContent",{})}),t.on("reload",function(e){location.reload(!0)}),t.on("channelPush",function(n){e.$emit("addChannel",n)}),e.$on("logout",function(){t.emit("logout")})};return i.start=function(){d(function(){return c()})},i.logout=function(){e.$emit("logout"),o.remove(),location.reload(!0)},i.activateScreenAndConnect=function p(t){var o=new XMLHttpRequest;o.open("POST",s.resource.server+s.resource.uri+"/screen/activate",!0),o.setRequestHeader("Content-Type","application/json"),o.onload=function(i){if(4===o.readyState&&200===o.status)i=JSON.parse(o.responseText),l(i.token);else if(4===o.readyState&&409===o.status){i=JSON.parse(o.responseText);var r=confirm(i.message);if(r===!0){var a=new XMLHttpRequest;a.open("POST",s.resource.server+s.resource.uri+"/screen/kick",!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("Authorization","Bearer "+i.token),a.onload=function(e){p(t)},a.onerror=function(t){e.$apply(function(){n.error("Kick request failed.",t)})},a.send(JSON.stringify({token:i.token}))}}else e.$apply(function(){n.error(o.responseText,o)})},o.onerror=function(t){e.$apply(function(){n.error("Activation request failed.",t)})},o.send(JSON.stringify({activationCode:t,apikey:s.apikey}))},i}]),angular.module("ikApp").directive("slide",["cssInjector",function(e){"use strict";return{restrict:"E",scope:{ikSlide:"=",show:"=",arrayId:"=",channelId:"=",index:"=",regionId:"=",scale:"="},link:function(n,t,o){n.ikSlide.uniqueId=null,o.$observe("regionId",function(e){e&&(n.ikSlide.uniqueId=""+n.regionId+"-"+n.arrayId+"-"+n.channelId+"-"+n.index)}),o.$observe("ikSlide",function(t){t&&(window.slideFunctions.indexOf(n.ikSlide.js_script_id)===-1?$.getScript(n.ikSlide.js_path,function(){window.slideFunctions[n.ikSlide.js_script_id].setup(n)}):window.slideFunctions[n.ikSlide.js_script_id].setup(n),e.add(n.ikSlide.css_path))})},template:'<div data-ng-include="ikSlide.template_path"></div>'}}]),function(){"use strict";var e;e=angular.module("itkDateComponent",[]),e.directive("dateComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/date/date.html?"+window.config.version,scope:{theme:"@"},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=new Date},6e4);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e;e=angular.module("itkDigitalClockComponent",[]),e.directive("digitalClockComponent",["$interval",function(e){return{restrict:"E",replace:!0,templateUrl:"app/shared/components/digital-clock/digital-clock.html?"+window.config.version,scope:{},link:function(n){n.thisDate=new Date;var t=e(function(){n.thisDate=Date.now()},1e3);n.$on("$destroy",function(){angular.isDefined(t)&&(e.cancel(t),t=void 0)})}}}])}.call(this),function(){"use strict";var e,n=!1;e=angular.module("itkKeypress",[]),e.directive("itkKeypress",function(){return function(e,t,o){t.bind("keydown keypress",function(t){return t.which===Number(o.modifier)?void(n=!0):(n&&t.which===Number(o.key)&&(e.$apply(function(){e.$eval(o.itkKeypress)}),t.preventDefault()),void(n=!1))})}})}.call(this);